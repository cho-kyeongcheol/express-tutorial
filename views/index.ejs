<!DOCTYPE html>
<html>
<%- include('./common/head') -%>

<body>
  <div class="container">
    <% if (user) { %>
      <div>
        <div class="title">
          현재 상태
        </div>
        <div>
          로그인
        </div>
        <div class="title">
          사용자명
        </div>
        <div id="username">
          <%= user.username %>
        </div>
        <button onclick="logout()" type="button" class="btn btn-secondary mt-20">로그아웃</button>
      </div>
    <% } else { %>
      <div class="title">
        현재 상태
      </div>
      <div>
        비로그인
      </div>
      <button onclick="login()" type="button" class="btn btn-secondary mt-20">로그인</button>
    <% } %>

    <div class="row mt-20">
      <div class="col">
        <input id="inputText" type='text' class='form-control' placeholder="입력하세요"> 
      </div>
      <div class="col">
        <button class="btn btn-secondary" onclick="insertTodo()">등록</button>
      </div>
    </div>

    <div class="title">
      게시판 출력
    </div>

    <table id="todo_list">
    </table>

  </div>
    
  <%- include('./common/javascript') -%>
  <script>
    // pass
  </script>
  <script>
    // enter key bind
    $("#inputText").keydown(function (key) {
      if (key.keyCode == 13) {
        board();
      }
    });

    $(function() {
      readTodo();
    });

    function readTodo(){
      $.post("/api/vi/board/read/", {
        // pass
      }).done(function (data) {
        var todos = data.data;
        console.log('todos = ', todos)
        todos.forEach(el => {
          const content = `
          <tr id="row_${el.id}">
            <td>
              <input id="borad_list" type='text' class='form-control mt-10 mb-15' placeholder="${el.content}">
            </td>
            <td>
              <button class="btn btn-primary">수정</button>
            </td>
            <td>
              <button class="btn btn-secondary" onclick="deleteTodo(${el.id})">삭제</button>
            </td>
          </tr>
          `
          console.log(content);
          $('#todo_list').prepend(content);
        });

      })
    }

    function deleteTodo(id) {
      console.log('id = ', id)
      $.post("/api/vi/board/delete/", {
        id: id
      }).done(function (data) {
        if (data.result === 'fail') {
          Swal.fire({
            icon: 'error',
            title: '삭제!',
            text: '실패!'
          })
        } else {
          $('#row_' + id).remove();
        }
      })
    }
    
    function insertTodo() {
      var inputText = $('#inputText').val();
      $.post("/api/v1/board/insert", {
        inputText: inputText
      }).done(function (data) {
        if (data.result === 'fail') {
          Swal.fire({
            icon: 'error',
            title: '등록!',
            text: '실패!'
          })
        } else {
          // success
          var data = data.data;
          const content = `
          <tr id="row_${data.id}">
            <td>
              <input id="borad_list" type='text' class='form-control mt-10 mb-15' placeholder="${data.content}">
            </td>
            <td>
              <button class="btn btn-primary">수정</button>
            </td>
            <td>
              <button class="btn btn-secondary" onclick="deleteTodo(${data.id})">삭제</button>
            </td>
          </tr>
          `
          console.log(content);
          $('#todo_list').prepend(content);
        }
      });
    }

    function login() {
      window.location.href = "/login";
    }

    function logout() {
      var inputName = $('#inputName').val();
      $.post("/api/v1/logout", {
        inputName: inputName
      }).done(function (data) {
        if (data.result === 'fail') {
          alert('로그아웃에 실패하였습니다.')
        } else {
          window.location.href = "/";
        }
      });
    }
  </script>
</body>
</html>